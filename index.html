<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ†æ•°ã®ãŸã—ç®—ã²ãç®— é€šåˆ†ãƒã‚¹ã‚¿ãƒ¼</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (JSXå¤‰æ›ç”¨) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS (ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ç”¨) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
        }
        @keyframes pop-in {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        .animate-pop-in {
            animation: pop-in 0.3s ease-out forwards;
        }
        @keyframes float-up {
            0% { transform: translateY(20px) scale(0.5); opacity: 0; }
            10% { transform: translateY(0) scale(1); opacity: 1; }
            60% { transform: translateY(-20px) scale(1.1); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.3); opacity: 0; }
        }
        .animate-float-up {
            animation: float-up 2.0s ease-out forwards;
        }
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            height: 30px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 28px;
            width: 28px;
            border-radius: 50%;
            background: #f97316;
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: #bfdbfe;
            border-radius: 4px;
        }
        .custom-input-focus {
            background-color: #fff7ed !important;
            border-color: #f97316 !important;
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.4);
            z-index: 10;
        }
        .num-font {
            font-family: 'Zen Maru Gothic', sans-serif;
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body class="bg-white text-gray-800 h-screen w-screen flex flex-col">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CLEAR_THRESHOLD = 25;

        // æ•°å­¦ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
        const lcm = (a, b) => (a * b) / gcd(a, b);
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        // å€æ•°ãƒªã‚¹ãƒˆç”Ÿæˆ
        const getMultiples = (num, target) => {
            const multiples = [];
            let i = 1;
            while (true) {
                const m = num * i;
                multiples.push(m);
                if (m >= target) {
                    break; 
                }
                i++;
                if (i > 50) break;
            }
            return multiples;
        };

        const playCorrectSound = () => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const playTone = (freq, startTime, duration) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, startTime);
                    gain.gain.setValueAtTime(0.1, startTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(startTime);
                    osc.stop(startTime + duration);
                };
                const now = ctx.currentTime;
                playTone(784, now, 0.6);
                playTone(1046.5, now + 0.2, 0.8);
            } catch (e) { console.error("Audio play failed", e); }
        };

        const RANKS = [
            { threshold: 0, title: "è¦‹ç¿’ã„", color: "text-gray-500" },
            { threshold: 5, title: "ã‹ã‘å‡ºã—", color: "text-green-500" },
            { threshold: 10, title: "ãƒ–ãƒ­ãƒ³ã‚ºç´š", color: "text-orange-700" },
            { threshold: 25, title: "ã‚·ãƒ«ãƒãƒ¼ç´š", color: "text-gray-400" },
            { threshold: 50, title: "ã‚´ãƒ¼ãƒ«ãƒ‰ç´š", color: "text-yellow-500" },
            { threshold: 75, title: "ãƒ—ãƒ©ãƒãƒŠç´š", color: "text-cyan-500" },
            { threshold: 90, title: "è¨ˆç®—ç‹", color: "text-red-500" },
            { threshold: 100, title: "ãƒã‚¹ã‚¿ãƒ¼", color: "text-indigo-600" } 
        ];

        const getRankInfo = (diamonds) => {
            let current = RANKS[0];
            let next = RANKS[1];
            for (let i = 0; i < RANKS.length; i++) {
                if (diamonds >= RANKS[i].threshold) {
                    current = RANKS[i];
                    next = RANKS[i + 1] || null; 
                }
            }
            return { current, next };
        };

        const OwlIcon = ({ rankTitle }) => {
            let head = null;
            let chest = null;
            let mantle = false;
            if (rankTitle === 'ã‹ã‘å‡ºã—') { chest = 'ğŸ”°'; }
            else if (rankTitle.includes('ãƒ–ãƒ­ãƒ³ã‚º')) { head = 'ğŸ“'; chest = 'ğŸ¥‰'; }
            else if (rankTitle.includes('ã‚·ãƒ«ãƒãƒ¼')) { head = 'ğŸ“'; chest = 'ğŸ¥ˆ'; }
            else if (rankTitle.includes('ã‚´ãƒ¼ãƒ«ãƒ‰')) { head = 'ğŸ“'; chest = 'ğŸ¥‡'; }
            else if (rankTitle.includes('ãƒ—ãƒ©ãƒãƒŠ')) { head = 'ğŸ“'; chest = 'ğŸ’'; }
            else if (rankTitle === 'è¨ˆç®—ç‹') { head = 'ğŸ‘‘'; chest = 'â­'; }
            else if (rankTitle === 'ãƒã‚¹ã‚¿ãƒ¼') { head = 'ğŸ‘‘'; chest = 'â­'; mantle = true; }
            return (
                <div className="relative inline-block w-14 h-14 flex items-center justify-center shrink-0">
                    {mantle && <div className="absolute top-3 left-1 w-12 h-10 bg-red-500 rounded-lg -z-10 transform -rotate-6 shadow-sm"></div>}
                    <span className="text-5xl z-10 relative">ğŸ¦‰</span>
                    {head && <span className="absolute -top-2 left-1/2 transform -translate-x-1/2 text-2xl z-20 drop-shadow-md">{head}</span>}
                    {chest && <span className="absolute bottom-0 left-1/2 transform -translate-x-1/2 text-xl z-30 drop-shadow-md filter">{chest}</span>}
                </div>
            );
        };

        const LEVEL_INFO = [
            { id: 1, title: 'ãŸã—ç®— 1', sub: 'åˆ†æ¯ãŒåŒã˜', desc: 'åˆ†æ¯ãŒåŒã˜åˆ†æ•°ã®ãŸã—ç®—', type: 'add' },
            { id: 2, title: 'ãŸã—ç®— 2', sub: 'åˆ†æ¯ãŒã¡ãŒã†', desc: 'åˆ†æ¯ãŒã¡ãŒã†åˆ†æ•°ã®ãŸã—ç®—', type: 'add' },
            { id: 3, title: 'ãŸã—ç®— 3', sub: 'å¸¯ãƒ»åŒåˆ†æ¯', desc: 'åˆ†æ¯ãŒåŒã˜å¸¯åˆ†æ•°ã®ãŸã—ç®—', type: 'add' },
            { id: 4, title: 'ãŸã—ç®— 4', sub: 'å¸¯ãƒ»ç•°åˆ†æ¯', desc: 'åˆ†æ¯ãŒã¡ãŒã†å¸¯åˆ†æ•°ã®ãŸã—ç®—', type: 'add' },
            { id: 5, title: 'ã²ãç®— 1', sub: 'åˆ†æ¯ãŒåŒã˜', desc: 'åˆ†æ¯ãŒåŒã˜åˆ†æ•°ã®ã²ãç®—', type: 'sub' },
            { id: 6, title: 'ã²ãç®— 2', sub: 'åˆ†æ¯ãŒã¡ãŒã†', desc: 'åˆ†æ¯ãŒã¡ãŒã†åˆ†æ•°ã®ã²ãç®—', type: 'sub' },
            { id: 7, title: 'ã²ãç®— 3', sub: 'å¸¯ãƒ»åŒåˆ†æ¯', desc: 'åˆ†æ¯ãŒåŒã˜å¸¯åˆ†æ•°ã®ã²ãç®—', type: 'sub' },
            { id: 8, title: 'ã²ãç®— 4', sub: 'å¸¯ãƒ»ç•°åˆ†æ¯', desc: 'åˆ†æ¯ãŒã¡ãŒã†å¸¯åˆ†æ•°ã®ã²ãç®—', type: 'sub' },
            { id: 9, title: 'ï¼“ã¤ã®åˆ†æ•° 1', sub: 'çœŸåˆ†æ•°', desc: '3ã¤ã®åˆ†æ•°ã®è¨ˆç®—ï¼ˆçœŸåˆ†æ•°ï¼‰', type: 'mix' },
            { id: 10, title: 'ï¼“ã¤ã®åˆ†æ•° 2', sub: 'å¸¯åˆ†æ•°', desc: '3ã¤ã®åˆ†æ•°ã®è¨ˆç®—ï¼ˆå¸¯åˆ†æ•°ï¼‰', type: 'mix' },
        ];

        const getProblemKey = (p) => {
            const fStr = (f) => `${f.i}:${f.n}:${f.d}`;
            if (p.config.terms === 2 && p.op1 === '+') {
                const s1 = fStr(p.f1);
                const s2 = fStr(p.f2);
                const sorted = [s1, s2].sort();
                return `add|${sorted[0]}|${sorted[1]}`;
            }
            let key = `${fStr(p.f1)}|${p.op1}|${fStr(p.f2)}`;
            if (p.f3) {
                key += `|${p.op2}|${fStr(p.f3)}`;
            }
            return key;
        };

        const generateProblem = (level) => {
            let config = { type: 'add', terms: 2, mixed: false, diffDenom: false };
            switch(level) {
                case 1: config = { type: 'add', terms: 2, mixed: false, diffDenom: false }; break;
                case 2: config = { type: 'add', terms: 2, mixed: false, diffDenom: true }; break;
                case 3: config = { type: 'add', terms: 2, mixed: true,  diffDenom: false }; break;
                case 4: config = { type: 'add', terms: 2, mixed: true,  diffDenom: true }; break;
                case 5: config = { type: 'sub', terms: 2, mixed: false, diffDenom: false }; break;
                case 6: config = { type: 'sub', terms: 2, mixed: false, diffDenom: true }; break;
                case 7: config = { type: 'sub', terms: 2, mixed: true,  diffDenom: false }; break;
                case 8: config = { type: 'sub', terms: 2, mixed: true,  diffDenom: true }; break;
                case 9: config = { type: 'mix', terms: 3, mixed: false, diffDenom: true }; break;
                case 10: config = { type: 'mix', terms: 3, mixed: true,  diffDenom: true }; break;
            }

            const simplifyFraction = (i, n, d) => {
               const g = gcd(n, d);
               return { i, n: n / g, d: d / g };
            };

            const createFraction = (isMixed, isDiff, baseDenom) => {
                const d = isDiff ? getRandomInt(2, 9) : baseDenom;
                const n = getRandomInt(1, d - 1);
                const i = isMixed ? getRandomInt(1, 3) : 0;
                return simplifyFraction(i, n, d);
            };

            let f1, f2, f3;
            // è¨˜å·ã‚’å…¨è§’ã€Œï¼ã€ã«å¤‰æ›´
            let op1 = config.type === 'mix' ? (Math.random() > 0.5 ? '+' : 'ï¼') : (config.type === 'add' ? '+' : 'ï¼');
            let op2 = config.type === 'mix' ? (Math.random() > 0.5 ? '+' : 'ï¼') : null;

            let commonD, totalNum;
            let loopCount = 0;

            while (loopCount < 200) {
                 loopCount++;
                 const baseD = getRandomInt(3, 9);
                 f1 = createFraction(config.mixed, config.diffDenom, baseD);
                 f2 = createFraction(config.mixed, config.diffDenom, config.diffDenom ? 0 : baseD); 
                 f3 = (config.terms === 3) ? createFraction(config.mixed, config.diffDenom, config.diffDenom ? 0 : baseD) : null;

                 if (f1.i === f2.i && f1.n === f2.n && f1.d === f2.d) continue;
                 if (f3) {
                     if (f2.i === f3.i && f2.n === f3.n && f2.d === f3.d) continue;
                     if (f1.i === f3.i && f1.n === f3.n && f1.d === f3.d) continue;
                 }

                 if (!config.diffDenom) {
                     if (f1.d !== f2.d) continue;
                     if (f3 && f1.d !== f3.d) continue;
                 } else {
                     if (f1.d === f2.d) continue;
                 }

                 const val = (f) => f.i + f.n/f.d;
                 
                 // å…±é€šåˆ†æ¯ã§ã®åˆ†å­ã‚’è¨ˆç®—ã—ã¦æ¯”è¼ƒ
                 const calcCommonD = (f3) ? lcm(lcm(f1.d, f2.d), f3.d) : lcm(f1.d, f2.d);
                 const getNum = (f, cd) => f.n * (cd / f.d);

                 if (config.type === 'sub' || (op1 === 'ï¼' && config.terms === 2)) {
                     // å…¨ä½“ã®å¤§å°æ¯”è¼ƒï¼ˆè² ã®æ•°ã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰
                     if (val(f1) <= val(f2)) {
                          // å…¥ã‚Œæ›¿ãˆã¦æ­£ã«ãªã‚‹ãªã‚‰å…¥ã‚Œæ›¿ãˆ
                          if (val(f2) > val(f1)) { [f1, f2] = [f2, f1]; }
                          else continue; 
                     }
                     
                     // â˜…è¿½åŠ è¦ä»¶: åˆ†å­åŒå£«ã§å¼•ã‘ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç¹°ã‚Šä¸‹ãŒã‚Šãªã—ï¼‰
                     // å…±é€šåˆ†æ¯ã§ã®åˆ†å­ã«å¤‰æ›ã—ã¦æ¯”è¼ƒ
                     const n1 = getNum(f1, calcCommonD);
                     const n2 = getNum(f2, calcCommonD);
                     // å¸¯åˆ†æ•°ã®å ´åˆã€æ•´æ•°éƒ¨åˆ†ãŒååˆ†ã«ã‚ã£ã¦ã‚‚åˆ†å­ãŒå¼•ã‘ãªã„ã‚±ãƒ¼ã‚¹ï¼ˆç¹°ã‚Šä¸‹ãŒã‚Šï¼‰ã‚’é™¤å¤–ã™ã‚‹
                     // åˆ†å­éƒ¨åˆ†ã ã‘ã®æ¯”è¼ƒ: (f1.n * å€ç‡) < (f2.n * å€ç‡) ãªã‚‰NG
                     if (n1 < n2) continue; 
                 }
                 
                 commonD = calcCommonD;
                 
                 const toImproperNum = (f, cd) => (f.i * cd + f.n * (cd / f.d));
                 let num1 = toImproperNum(f1, commonD);
                 let num2 = toImproperNum(f2, commonD);
                 
                 totalNum = op1 === '+' ? num1 + num2 : num1 - num2;
                 if (f3) {
                    let num3 = toImproperNum(f3, commonD);
                    totalNum = op2 === '+' ? totalNum + num3 : totalNum - num3;
                 }

                 if (totalNum <= 0 || totalNum % commonD === 0) continue;
                 break;
            }

            const ansI = Math.floor(totalNum / commonD);
            const ansN = totalNum % commonD;
            const ansD = commonD;

            const g = gcd(totalNum, commonD);
            const simpRaw = { i: 0, n: totalNum/g, d: commonD/g };
            const finalMixed = { i: Math.floor(simpRaw.n / simpRaw.d), n: simpRaw.n % simpRaw.d, d: simpRaw.d };

            const isSimplifiable = (g > 1);
            const isImproper = (simpRaw.n >= simpRaw.d); 
            
            const getMid = (f) => ({ i: f.i, n: f.n * (commonD / f.d), d: commonD });
            const mid1 = getMid(f1);
            const mid2 = getMid(f2);
            const mid3 = f3 ? getMid(f3) : null;
            
            const raw = { i: 0, n: totalNum, d: commonD };

            return { 
                f1, f2, f3, op1, op2, config, commonD, mid1, mid2, mid3,
                raw, simpRaw, finalMixed, isSimplifiable, isImproper,
                ans: { i: ansI, n: ansN, d: ansD } 
            };
        };

        // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
        const FractionDisplay = ({ f }) => (
            <div className="flex items-center num-font mx-0.5">
                {f.i > 0 && <span className="text-2xl md:text-3xl font-black mr-1 text-black">{f.i}</span>}
                <div className="flex flex-col items-center justify-center font-bold">
                    <span className="text-2xl md:text-3xl leading-none text-black mb-[1px]">{f.n}</span>
                    <div className="w-full min-w-[24px] h-[3px] md:h-[4px] bg-black rounded-sm"></div>
                    <span className="text-2xl md:text-3xl leading-none text-black mt-[-4px]">{f.d}</span>
                </div>
            </div>
        );

        const FractionInput = ({ intVal, numVal, denomVal, showInt, activeField, onFocus, inputType, index }) => {
            const inputClass = "w-6 md:w-8 h-8 md:h-10 text-2xl md:text-3xl text-center outline-none bg-transparent placeholder-gray-400 cursor-pointer font-bold text-black p-0 leading-none";
            const borderClass = "border border-gray-300";
            const getActiveClass = (part) => (activeField && activeField.type === inputType && activeField.index === index && activeField.part === part) ? "custom-input-focus" : "";

            return (
                <div className={`flex items-center bg-white p-0.5 mx-0`}>
                    {showInt && (
                        <input
                            type="text" inputMode="none" readOnly value={intVal}
                            onClick={(e) => { e.stopPropagation(); onFocus('i'); }}
                            className={`${inputClass.replace('text-center', 'text-right')} ${borderClass} rounded mr-1 pr-1 bg-gray-50 ${getActiveClass('i')}`}
                            placeholder="?"
                        />
                    )}
                    <div className="flex flex-col items-center justify-center">
                        <input
                            type="text" inputMode="none" readOnly value={numVal}
                            onClick={(e) => { e.stopPropagation(); onFocus('n'); }}
                            className={`${inputClass} ${borderClass} rounded bg-gray-50 mb-[2px] ${getActiveClass('n')}`}
                            placeholder="?"
                        />
                        {/* ç‹¬ç«‹ã—ãŸåˆ†æ•°ã®ç·š */}
                        <div className="w-full h-[3px] md:h-[4px] bg-black relative z-20"></div>
                        <input
                            type="text" inputMode="none" readOnly value={denomVal}
                            onClick={(e) => { e.stopPropagation(); onFocus('d'); }}
                            className={`${inputClass} ${borderClass} rounded bg-gray-50 mt-[2px] ${getActiveClass('d')}`}
                            placeholder="?"
                        />
                    </div>
                </div>
            );
        };

        const FractionBar = ({ f, splitFactor = 1, color = "bg-blue-500", label }) => {
            const totalSegments = f.d * splitFactor;
            return (
                <div className="flex items-center gap-3 w-full transition-all duration-300">
                    <div className="w-20 shrink-0 origin-left"><FractionDisplay f={f} /></div>
                    <div className="flex-1">
                        <div className="flex justify-end items-end mb-0.5 px-1">
                            <span className="text-[10px] font-bold text-gray-500"></span>
                            <span className="text-[10px] font-bold text-gray-600 bg-white/80 px-1.5 rounded border border-gray-300">ã‚ã‚‚ã‚Š: {totalSegments}</span>
                        </div>
                        <div className="relative h-10 w-full border-4 border-gray-500 rounded-none overflow-hidden bg-white flex shadow-sm">
                            <div className={`h-full ${color} transition-all duration-500 ease-out`} style={{ width: `${(f.n / f.d) * 100}%` }} />
                            <div className="absolute inset-0 flex w-full h-full">
                                {Array.from({ length: totalSegments }).map((_, i) => (
                                    <div key={i} className="flex-1 border-r border-gray-500 last:border-r-0" />
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const NumberKeypad = ({ onInput }) => {
            const numbers = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            return (
                <div className="w-full py-2 px-1 bg-white border-t border-gray-200">
                    <div className="flex flex-nowrap justify-center gap-1 w-full max-w-2xl mx-auto px-1">
                        {numbers.map((num) => (
                            <button key={num} onClick={(e) => { e.preventDefault(); onInput(String(num)); }} onMouseDown={(e) => e.preventDefault()}
                                className="flex-1 h-12 bg-white border-2 border-gray-300 rounded-lg shadow-sm text-xl md:text-2xl font-bold text-gray-700 hover:bg-orange-50 active:bg-orange-200 active:scale-95 transition-all flex items-center justify-center min-w-0">
                                {num}
                            </button>
                        ))}
                        <button onClick={(e) => { e.preventDefault(); onInput('BS'); }} onMouseDown={(e) => e.preventDefault()}
                            className="flex-1 h-12 bg-red-50 border-2 border-red-200 rounded-lg shadow-sm text-xl md:text-2xl font-bold text-red-500 hover:bg-red-100 active:scale-95 transition-all flex items-center justify-center min-w-0">
                            âŒ«
                        </button>
                    </div>
                </div>
            );
        };

        // --- ãƒ¡ãƒ¢ãƒ‘ãƒƒãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
        const MemoPad = () => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const parent = canvas.parentElement;
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¦ªè¦ç´ ã«åˆã‚ã›ã‚‹
                // Canvasã®æç”»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã‚µã‚¤ã‚ºã¨è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’åˆã‚ã›ã‚‹
                const resizeCanvas = () => {
                     canvas.width = parent.clientWidth;
                     // é«˜ã•ã‚’2å€ã«è¨­å®š (h-40 -> h-80 ç›¸å½“ã€ã¾ãŸã¯æŒ‡å®šå€¤)
                     // ã“ã“ã§ã¯è¦ªã®é«˜ã•ã«åˆã‚ã›ã‚‹ãŒã€è¦ªã®ã‚¹ã‚¿ã‚¤ãƒ«ã§é«˜ã•ã‚’æŒ‡å®šã™ã‚‹
                     canvas.height = parent.clientHeight;
                     
                     const ctx = canvas.getContext('2d');
                     ctx.strokeStyle = '#555';
                     ctx.lineWidth = 2;
                     ctx.lineCap = 'round';
                };
                
                resizeCanvas();
                // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚‚å†è¨­å®šï¼ˆå¿…è¦ãªã‚‰ï¼‰
                // window.addEventListener('resize', resizeCanvas);
                // return () => window.removeEventListener('resize', resizeCanvas);
            }, []);

            const getPos = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            };

            const startDrawing = (e) => {
                // e.preventDefault() ã¯ touch-action: none; ã§ä»£ç”¨ã™ã‚‹ã‹ã€ã“ã“ã§ã™ã‚‹ã‹
                // Reactã®åˆæˆã‚¤ãƒ™ãƒ³ãƒˆã§ã¯ preventDefault ãŒåŠ¹ãã«ãã„å ´åˆãŒã‚ã‚‹ãŒã€
                // nativeEvent ã‚’ä½¿ã†æ‰‹ã‚‚ã‚ã‚‹ã€‚ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€‚
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineTo(x, y);
                ctx.stroke();
            };

            const stopDrawing = () => {
                setIsDrawing(false);
            };
            
            const clear = () => {
                 const canvas = canvasRef.current;
                 const ctx = canvas.getContext('2d');
                 ctx.clearRect(0, 0, canvas.width, canvas.height);
            };

            return (
                 // é«˜ã•ã‚’ h-40 ã‹ã‚‰ h-80 (20rem, 320px) ã«å¤‰æ›´ã—ã¦2å€ã«
                 <div className="relative w-full h-80 border-4 border-dashed border-gray-300 rounded-xl bg-gray-50 overflow-hidden touch-none">
                     <div className="absolute top-2 left-2 text-xs font-bold text-gray-400 select-none pointer-events-none">âœï¸ è¨ˆç®—ãƒ¡ãƒ¢</div>
                     <button onClick={clear} className="absolute top-2 right-2 bg-gray-200 hover:bg-gray-300 text-xs px-2 py-1 rounded text-gray-600 z-10 border border-gray-300">æ¶ˆã™</button>
                     <canvas 
                        ref={canvasRef} 
                        className="w-full h-full cursor-crosshair"
                        onMouseDown={startDrawing}
                        onMouseMove={draw}
                        onMouseUp={stopDrawing}
                        onMouseLeave={stopDrawing}
                        onTouchStart={startDrawing}
                        onTouchMove={draw}
                        onTouchEnd={stopDrawing}
                     />
                 </div>
            );
        };

        const CategorySection = ({ title, levelList, onStart, levelScores, colorTheme }) => {
            const diamonds = levelList.reduce((acc, l) => acc + (levelScores[l.id] || 0), 0);
            const progress = Math.min(100, (diamonds / 100) * 100);
            const rankData = getRankInfo(diamonds);

            let themeClass = "border-purple-300 bg-white", btnClass = "bg-purple-50 border-purple-200 text-purple-800", barClass = "from-purple-300 to-purple-500";
            if (colorTheme === 'orange') {
                themeClass = "border-orange-300 bg-white";
                btnClass = "bg-orange-50 border-orange-200 text-orange-800";
                barClass = "from-orange-300 to-orange-500";
            } else if (colorTheme === 'green') {
                themeClass = "border-green-300 bg-white";
                btnClass = "bg-green-50 border-green-200 text-green-800";
                barClass = "from-green-300 to-green-500";
            }

            return (
                <div className={`w-full p-4 rounded-3xl shadow-sm border-4 ${themeClass} mb-6`}>
                    <div className="flex justify-between items-end mb-3">
                        <div className="flex items-center gap-3">
                            <OwlIcon rankTitle={rankData.current.title} />
                            <div>
                                <h2 className="text-xl font-black text-gray-700">{title}</h2>
                                <p className={`text-sm font-bold ${rankData.current.color}`}>ç¾åœ¨ã®ç§°å·ï¼š{rankData.current.title}</p>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-2xl font-black text-gray-800 leading-none">
                                ğŸ’ <span className={colorTheme === 'orange' ? 'text-orange-500' : colorTheme === 'green' ? 'text-green-500' : 'text-purple-500'}>{diamonds}</span>
                                <span className="text-sm text-gray-400 font-bold"> / 100</span>
                            </div>
                        </div>
                    </div>
                    <div className="w-full h-3 bg-gray-100 rounded-full overflow-hidden shadow-inner mb-4">
                        <div className={`h-full bg-gradient-to-r ${barClass} transition-all duration-1000 ease-out`} style={{ width: `${progress}%` }}></div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {levelList.map(l => {
                            const score = levelScores[l.id] || 0;
                            const isCleared = score >= CLEAR_THRESHOLD;
                            return (
                                <button key={l.id} onClick={() => onStart(l.id)} 
                                    className={`w-full p-3 rounded-xl border-2 transition-transform active:scale-95 flex items-center justify-between text-left relative ${btnClass} ${isCleared ? 'ring-2 ring-yellow-400' : ''}`}>
                                    <div>
                                        <span className="block text-lg font-black leading-none mb-1 flex items-center">
                                            Lv.{l.id}
                                            {isCleared && <span className="ml-2 text-xl">ğŸ‘‘</span>}
                                        </span>
                                        <span className="block text-sm font-bold opacity-90">{l.sub}</span>
                                    </div>
                                    <div className="flex flex-col items-end justify-center pl-2">
                                        <span className={`text-sm font-bold px-2 py-1 rounded-lg whitespace-nowrap border ${isCleared ? 'bg-yellow-100 text-yellow-700 border-yellow-300' : 'bg-white/60 text-blue-600 border-blue-100'}`}>
                                            {isCleared ? 'CLEAR!' : `ğŸ’ï¼š${score}å€‹`}
                                        </span>
                                    </div>
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const StartScreen = ({ onStart, levelScores }) => {
            const addLevels = LEVEL_INFO.filter(l => l.type === 'add');
            const subLevels = LEVEL_INFO.filter(l => l.type === 'sub');
            const mixLevels = LEVEL_INFO.filter(l => l.type === 'mix');

            return (
                <div className="h-full w-full flex flex-col items-center p-4 animate-pop-in overflow-y-auto bg-white">
                    <div className="text-center mb-6 mt-2 shrink-0">
                        <span className="inline-block py-1 px-3 rounded-full bg-indigo-100 text-indigo-600 font-bold text-xs mb-2">
                            å°å­¦5å¹´ç”Ÿå‘ã‘
                        </span>
                        <h1 className="text-3xl md:text-4xl font-black text-indigo-600 leading-tight tracking-tight">
                            åˆ†æ•°ã®ãŸã—ç®—ã²ãç®—<br/>
                            <span className="text-orange-500">é€šåˆ†ãƒã‚¹ã‚¿ãƒ¼ âœ¨</span>
                        </h1>
                    </div>
                    <div className="w-full max-w-xl pb-10">
                        <CategorySection title="ãŸã—ç®—" levelList={addLevels} onStart={onStart} levelScores={levelScores} colorTheme="orange" />
                        <CategorySection title="ã²ãç®—" levelList={subLevels} onStart={onStart} levelScores={levelScores} colorTheme="green" />
                        <CategorySection title="ï¼“ã¤ã®åˆ†æ•°" levelList={mixLevels} onStart={onStart} levelScores={levelScores} colorTheme="purple" />
                    </div>
                </div>
            );
        };

        const GameScreen = ({ onBack, initialLevel, onCorrectAnswer, levelScores }) => {
            const [level, setLevel] = useState(initialLevel);
            const [problem, setProblem] = useState(null);
            const [history, setHistory] = useState([]);
            const [evolutionMessage, setEvolutionMessage] = useState(null);

            const [userInt, setUserInt] = useState('');
            const [userNum, setUserNum] = useState('');
            const [userDenom, setUserDenom] = useState('');

            const [userMids, setUserMids] = useState([{i:'',n:'',d:''}, {i:'',n:'',d:''}, {i:'',n:'',d:''}]);
            const [userSimpImproperInt, setUserSimpImproperInt] = useState('');
            const [userSimpImproperNum, setUserSimpImproperNum] = useState('');
            const [userSimpImproperDenom, setUserSimpImproperDenom] = useState('');
            const [showImproperSimplify, setShowImproperSimplify] = useState(false);
            const [userMixedInt, setUserMixedInt] = useState('');
            const [userMixedNum, setUserMixedNum] = useState('');
            const [userMixedDenom, setUserMixedDenom] = useState('');
            const [showMixedConvert, setShowMixedConvert] = useState(false);
            const [userSimpInt, setUserSimpInt] = useState('');
            const [userSimpNum, setUserSimpNum] = useState('');
            const [userSimpDenom, setUserSimpDenom] = useState('');
            const [showSimplify, setShowSimplify] = useState(false);

            const [activeField, setActiveField] = useState(null);
            const [feedback, setFeedback] = useState('');
            const [isCorrect, setIsCorrect] = useState(false);
            const [commonSplit, setCommonSplit] = useState(1);
            const [showDiamondAnim, setShowDiamondAnim] = useState(false); 
            const [earnedDiamonds, setEarnedDiamonds] = useState(1);
            const [showHint, setShowHint] = useState(true);

            const [isFinished, setIsFinished] = useState(false);

            const currentLevelInfo = LEVEL_INFO.find(l => l.id === level);
            if (!currentLevelInfo) return null; 

            const categoryLevels = LEVEL_INFO.filter(l => l.type === currentLevelInfo.type);
            const categoryDiamonds = categoryLevels.reduce((acc, l) => acc + (levelScores[l.id] || 0), 0);
            const rankData = getRankInfo(categoryDiamonds);
            
            const currentLevelDiamonds = levelScores[level] || 0;
            const remainingForClear = Math.max(0, CLEAR_THRESHOLD - currentLevelDiamonds);
            
            const hasMid = problem ? problem.config.diffDenom : false;
            const showVisualizer = problem ? problem.config.terms === 2 : false;
            const maxSlider = problem ? Math.max(problem.commonD + 4, 12) : 12;

            const newProblem = (lvl = level) => {
                let p, key;
                let retry = 0;
                const maxRetries = 20;

                do {
                    p = generateProblem(lvl);
                    key = getProblemKey(p);
                    retry++;
                } while (history.includes(key) && retry < maxRetries);

                setProblem(p);
                
                setHistory(prev => {
                    const nextHistory = [...prev, key];
                    if (nextHistory.length > 50) nextHistory.shift();
                    return nextHistory;
                });

                setUserInt(''); setUserNum(''); setUserDenom('');
                setUserMids([{i:'',n:'',d:''}, {i:'',n:'',d:''}, {i:'',n:'',d:''}]);
                setUserSimpImproperInt(''); setUserSimpImproperNum(''); setUserSimpImproperDenom('');
                setShowImproperSimplify(false);
                setUserMixedInt(''); setUserMixedNum(''); setUserMixedDenom('');
                setShowMixedConvert(false);
                setUserSimpInt(''); setUserSimpNum(''); setUserSimpDenom('');
                setShowSimplify(false);
                setFeedback('');
                setIsCorrect(false);
                setIsFinished(false);
                setCommonSplit(1);
                setActiveField(null);
                setShowDiamondAnim(false); 
            };

            useEffect(() => {
                setHistory([]); 
                newProblem(level);
            }, [level]);

            const handlePadInput = (char) => {
                if (!activeField) { setFeedback('ã«ã‚…ã†ã‚Šã‚‡ãã™ã‚‹ ã°ã—ã‚‡ ã‚’ ãˆã‚‰ã‚“ã§ã­'); return; }
                const updateVal = (current) => {
                    if (char === 'BS') return current.slice(0, -1);
                    if (current.length >= 3) return current; 
                    return current + char;
                };
                const { type, index, part } = activeField;
                if (type === 'final') {
                    if (part === 'i') setUserInt(prev => updateVal(prev));
                    if (part === 'n') setUserNum(prev => updateVal(prev));
                    if (part === 'd') setUserDenom(prev => updateVal(prev));
                } else if (type === 'mid') {
                    const newMids = [...userMids];
                    newMids[index][part] = updateVal(newMids[index][part]);
                    setUserMids(newMids);
                } else if (type === 'simpImproper') {
                    if (part === 'i') setUserSimpImproperInt(prev => updateVal(prev));
                    if (part === 'n') setUserSimpImproperNum(prev => updateVal(prev));
                    if (part === 'd') setUserSimpImproperDenom(prev => updateVal(prev));
                } else if (type === 'mixed') {
                    if (part === 'i') setUserMixedInt(prev => updateVal(prev));
                    if (part === 'n') setUserMixedNum(prev => updateVal(prev));
                    if (part === 'd') setUserMixedDenom(prev => updateVal(prev));
                } else if (type === 'simp') {
                    if (part === 'i') setUserSimpInt(prev => updateVal(prev));
                    if (part === 'n') setUserSimpNum(prev => updateVal(prev));
                    if (part === 'd') setUserSimpDenom(prev => updateVal(prev));
                }
            };

            const triggerCorrect = () => {
                setIsCorrect(true);
                setIsFinished(true);
                setShowDiamondAnim(true);
                playCorrectSound();
                const points = (level >= 9) ? 2 : 1;
                setEarnedDiamonds(points);

                const rankBefore = getRankInfo(categoryDiamonds);
                const rankAfter = getRankInfo(categoryDiamonds + points);
                if (rankAfter.current.threshold > rankBefore.current.threshold) {
                    setTimeout(() => {
                        setEvolutionMessage(rankAfter.current.title);
                    }, 500);
                }

                onCorrectAnswer(level, points);
                
                if (remainingForClear > 0 && (remainingForClear - points) <= 0) {
                     setFeedback('ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼ ğŸ‰');
                }
            };

            const checkAnswer = () => {
                if (!problem) return;

                if (problem.config.diffDenom) {
                    const checkMid = (user, correct) => {
                        const un = parseInt(user.n), ud = parseInt(user.d);
                        if (isNaN(un) || isNaN(ud)) return false;
                        const ui = user.i === '' ? 0 : parseInt(user.i);
                        const intCheck = (correct.i === 0 && ui === 0) || (ui === correct.i);
                        return intCheck && un === correct.n && ud === correct.d;
                    };
                    const mid1OK = checkMid(userMids[0], problem.mid1);
                    const mid2OK = checkMid(userMids[1], problem.mid2);
                    
                    let mid3OK = true;
                    if (problem.f3) {
                         mid3OK = checkMid(userMids[2], problem.mid3);
                    }

                    if (!mid1OK || !mid2OK || !mid3OK) {
                        setFeedback('é€šåˆ†ï¼ˆã¾ã‚“ãªã‹ã®å¼ï¼‰ãŒã¡ãŒã†ã‚ˆã€‚ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’è¦‹ã¦ï¼');
                        return;
                    }
                }

                if (showMixedConvert) {
                    const i = userMixedInt === '' ? 0 : parseInt(userMixedInt);
                    const n = parseInt(userMixedNum);
                    const d = parseInt(userMixedDenom);
                    
                    if (isNaN(n) || isNaN(d)) {
                        setFeedback('å¸¯åˆ†æ•°ã‚’å…¥åŠ›ã—ã¦ã­ï¼');
                        return;
                    }
                    if (i === problem.finalMixed.i && n === problem.finalMixed.n && d === problem.finalMixed.d) {
                         setFeedback('ğŸ‰ ã™ã”ã„ï¼ã‹ã‚“ãºãï¼ ğŸ’GETï¼ ğŸ‰');
                         triggerCorrect();
                    } else {
                        setFeedback('å¸¯åˆ†æ•°ãŒã¡ãŒã†ã‹ã‚‚ï¼Ÿ');
                    }
                    return;
                }

                if (showSimplify) {
                    const i = userSimpInt === '' ? 0 : parseInt(userSimpInt);
                    const n = parseInt(userSimpNum);
                    const d = parseInt(userSimpDenom);
                    
                    if (isNaN(n) || isNaN(d)) {
                        setFeedback('ç´„åˆ†ã—ãŸç­”ãˆã‚’å…¥ã‚Œã¦ã­ï¼');
                        return;
                    }
                    if (i === problem.finalMixed.i && n === problem.finalMixed.n && d === problem.finalMixed.d) {
                        setFeedback('ğŸ‰ ã™ã”ã„ï¼ã‹ã‚“ãºãï¼ ğŸ’GETï¼ ğŸ‰');
                        triggerCorrect();
                    } else {
                        setFeedback('ã¾ã ç´„åˆ†ã§ãã‚‹ã‹ã‚‚ï¼Ÿ');
                    }
                    return;
                }

                if (showImproperSimplify) {
                    const i = userSimpImproperInt === '' ? 0 : parseInt(userSimpImproperInt);
                    const n = parseInt(userSimpImproperNum);
                    const d = parseInt(userSimpImproperDenom);
                    
                    if (isNaN(n) || isNaN(d)) {
                        setFeedback('ç´„åˆ†ã—ãŸåˆ†æ•°ã‚’å…¥ã‚Œã¦ã­ï¼');
                        return;
                    }
                    
                    const prevInt = userInt === '' ? 0 : parseInt(userInt);
                    
                    if (i !== prevInt) {
                         setFeedback('æ•´æ•°ã¯ãã®ã¾ã¾ï¼åˆ†æ•°ã‚’ç´„åˆ†ã—ã¦ã­');
                         return;
                    }
                    
                    const currentVal = i + n/d;
                    const correctVal = problem.raw.n / problem.raw.d;
                    
                    if (Math.abs(currentVal - correctVal) > 0.0001) {
                         setFeedback('è¨ˆç®—ãŒã¡ãŒã†ã‹ã‚‚');
                         return;
                    }
                    
                    if (gcd(n, d) > 1) {
                         setFeedback('ã¾ã ç´„åˆ†ã§ãã‚‹ã‚ˆ');
                         return;
                    }
                    
                    if (n >= d) {
                         setShowMixedConvert(true);
                         setFeedback('æ­£è§£ï¼æ¬¡ã¯å¸¯åˆ†æ•°ï¼ˆç¹°ã‚Šä¸ŠãŒã‚Šï¼‰ã«ã—ã¦ã¿ã‚ˆã†ï¼');
                         setActiveField({ type: 'mixed', index: null, part: 'i' });
                    } else {
                         setFeedback('ğŸ‰ ã™ã”ã„ï¼ã›ã„ã‹ã„ï¼ ğŸ’GETï¼ ğŸ‰');
                         triggerCorrect();
                    }
                    return;
                }

                const i = userInt === '' ? 0 : parseInt(userInt);
                const n = parseInt(userNum);
                const d = parseInt(userDenom);
                
                if (isNaN(n) || isNaN(d)) {
                    setFeedback('ç­”ãˆã‚’å…¥ã‚Œã¦ã­ï¼');
                    return;
                }

                const userVal = i + n/d;
                const correctRawVal = problem.raw.n / problem.raw.d;

                if (Math.abs(userVal - correctRawVal) < 0.0001) {
                    if (problem.isSimplifiable) {
                        if (n === problem.finalMixed.n && d === problem.finalMixed.d && i === problem.finalMixed.i) {
                             setFeedback('ğŸ‰ ã™ã”ã„ï¼ã›ã„ã‹ã„ï¼ ğŸ’GETï¼ ğŸ‰');
                             triggerCorrect();
                             return;
                        }
                        
                        setShowImproperSimplify(true);
                        setFeedback('ç´„åˆ†ã§ãã‚‹ã‚ˆ');
                        setActiveField({ type: 'simpImproper', index: null, part: 'n' });
                        
                        if (problem.config.mixed && i > 0) {
                            setUserSimpImproperInt(i.toString());
                        }
                        return;
                    }
                    
                    if (!problem.isSimplifiable && n >= d && i === 0 && problem.isImproper) {
                        setShowMixedConvert(true);
                        setFeedback('æ­£è§£ï¼å¸¯åˆ†æ•°ã«ã—ã¦ã¿ã‚ˆã†ï¼');
                        setActiveField({ type: 'mixed', index: null, part: 'i' });
                        return;
                    }
                    
                    if (n >= d) {
                        setShowMixedConvert(true);
                        setFeedback('æ­£è§£ï¼ç¹°ã‚Šä¸ŠãŒã‚Šï¼ˆå¸¯åˆ†æ•°ï¼‰ã«ã—ã¦ã¿ã‚ˆã†ï¼');
                        setActiveField({ type: 'mixed', index: null, part: 'i' });
                        return;
                    }

                    if (problem.isSimplifiable) {
                         if (n !== problem.finalMixed.n || d !== problem.finalMixed.d) {
                            setShowSimplify(true);
                            setFeedback('æ­£è§£ï¼æ¬¡ã¯ç´„åˆ†ã—ã¦ã¿ã‚ˆã†ï¼');
                            setActiveField({ type: 'simp', index: null, part: 'n' });
                            return;
                         }
                    }
                    setFeedback('ğŸ‰ ã™ã”ã„ï¼ã›ã„ã‹ã„ï¼ ğŸ’GETï¼ ğŸ‰');
                    triggerCorrect();
                } else {
                    setFeedback('è¨ˆç®—ãŒã¡ãŒã†ã‹ã‚‚ã€‚'); 
                }
            };

            if (!problem) return <div className="p-10 text-2xl">ã‚ˆã¿ã“ã¿ä¸­...</div>;

            // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
            let buttonText = 'ã“ãŸãˆã‚ã‚ã›';
            if (isCorrect) {
                buttonText = 'ã›ã„ã‹ã„ï¼';
            } else if (showMixedConvert) {
                buttonText = 'å¸¯åˆ†æ•°ã‚’ãƒã‚§ãƒƒã‚¯';
            } else if (showSimplify) {
                buttonText = 'ç´„åˆ†ã‚’ãƒã‚§ãƒƒã‚¯';
            } else if (showImproperSimplify) {
                buttonText = 'ç´„åˆ†ã‚’ãƒã‚§ãƒƒã‚¯';
            }

            return (
                <div className="h-full w-full flex flex-col p-2 max-w-5xl mx-auto animate-pop-in overflow-hidden relative bg-indigo-50">
                    {evolutionMessage && (
                        <div className="absolute inset-0 bg-black/50 z-50 flex items-center justify-center animate-pop-in">
                            <div className="bg-white p-8 rounded-3xl border-4 border-yellow-400 shadow-2xl flex flex-col items-center text-center">
                                <div className="text-6xl mb-4 animate-bounce">ğŸ¦‰âœ¨</div>
                                <h2 className="text-3xl font-black text-indigo-800 mb-2">ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—ï¼</h2>
                                <div className="text-5xl font-black text-orange-500 mb-4">{evolutionMessage}</div>
                                <p className="text-xl font-bold text-gray-600 mb-6">ã«é€²åŒ–ã—ãŸã‚ˆï¼</p>
                                <button 
                                    onClick={() => setEvolutionMessage(null)} 
                                    className="px-8 py-3 bg-indigo-600 text-white text-xl font-bold rounded-full shadow-lg hover:bg-indigo-700 transition-transform active:scale-95"
                                >
                                    ã‚„ã£ãŸã­ï¼
                                </button>
                            </div>
                        </div>
                    )}

                    {showDiamondAnim && (
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 animate-float-up pointer-events-none flex flex-col items-center drop-shadow-lg">
                            <div className="text-8xl">ğŸ’</div>
                            <div className="text-4xl font-black text-orange-500 bg-white rounded-full px-4 py-1 border-4 border-orange-200">
                                +{earnedDiamonds}
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-2 shrink-0">
                        <button onClick={onBack} className="text-gray-500 text-xs font-bold hover:text-orange-500 bg-white px-3 py-1 rounded-full shadow-sm border">
                            â—€ ãƒ¬ãƒ™ãƒ«ã›ã‚“ãŸã
                        </button>
                        <div className="flex gap-2">
                             <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-bold text-xs shadow-sm">
                                Lv.{level}
                            </span>
                            <span className="bg-white text-blue-600 border border-blue-200 px-3 py-1 rounded-full font-bold text-xs shadow-sm">
                                ğŸ’ï¼š{currentLevelDiamonds}å€‹
                            </span>
                        </div>
                    </div>

                    <div className="flex-1 bg-white rounded-2xl shadow-lg border-b-4 border-indigo-100 relative overflow-hidden flex flex-col">
                        <div className="bg-white p-4 border-b-2 border-dashed border-yellow-200 flex flex-col items-center shrink-0 z-10 shadow-sm transition-all duration-300 relative">
                            <button 
                                onClick={() => setShowHint(!showHint)}
                                className={`absolute bottom-2 left-2 text-xs font-bold px-3 py-1 rounded-full border-2 shadow-sm transition-all z-20 flex items-center gap-1 ${
                                    showHint 
                                    ? 'bg-yellow-100 text-yellow-700 border-yellow-300 hover:bg-yellow-200' 
                                    : 'bg-gray-100 text-gray-500 border-gray-300 hover:bg-gray-200'
                                }`}
                            >
                                <span>{showHint ? 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ ON' : 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ OFF'}</span>
                            </button>

                            <div className="w-full flex items-start gap-2 mb-4">
                                <div className="shrink-0 mt-1">
                                    <OwlIcon rankTitle={rankData.current.title} />
                                </div>
                                <div className="flex-1 bg-white border-2 border-indigo-200 rounded-2xl rounded-tl-none p-3 shadow-sm relative">
                                    <div className="flex justify-between items-start">
                                        <h3 className="text-base md:text-lg font-black text-indigo-900 leading-tight">
                                            {currentLevelInfo.desc}
                                        </h3>
                                        {remainingForClear > 0 ? (
                                            <span className="shrink-0 text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded ml-2 whitespace-nowrap">
                                                ã‚ã¨<span className="text-orange-500 text-sm ml-0.5">{remainingForClear}</span>
                                            </span>
                                        ) : (
                                            <span className="shrink-0 text-xs font-bold text-yellow-600 bg-yellow-100 border border-yellow-300 px-2 py-1 rounded ml-2 whitespace-nowrap">
                                                ğŸ‘‘ã‚¯ãƒªã‚¢æ¸ˆ
                                            </span>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex flex-wrap items-center justify-center gap-y-2">
                                <div className="flex items-center gap-1 md:gap-2">
                                    <FractionDisplay f={problem.f1} />
                                    <span className="text-3xl font-black text-black">{problem.op1}</span>
                                    <FractionDisplay f={problem.f2} />
                                    {problem.f3 && (
                                        <>
                                            <span className="text-3xl font-black text-black">{problem.op2}</span>
                                            <FractionDisplay f={problem.f3} />
                                        </>
                                    )}
                                    <span className="text-3xl font-black text-black">=</span>
                                </div>

                                {hasMid && (
                                    <div className="flex items-center gap-0.5 md:gap-1 mx-1">
                                            <FractionInput intVal={userMids[0].i} numVal={userMids[0].n} denomVal={userMids[0].d} showInt={problem.config.mixed} activeField={activeField} inputType="mid" index={0} onFocus={(part) => setActiveField({ type: 'mid', index: 0, part })} />
                                            <span className="text-2xl font-black text-black">{problem.op1}</span>
                                            <FractionInput intVal={userMids[1].i} numVal={userMids[1].n} denomVal={userMids[1].d} showInt={problem.config.mixed} activeField={activeField} inputType="mid" index={1} onFocus={(part) => setActiveField({ type: 'mid', index: 1, part })} />
                                            {problem.f3 && (
                                                <>
                                                    <span className="text-2xl font-black text-black">{problem.op2}</span>
                                                    <FractionInput intVal={userMids[2].i} numVal={userMids[2].n} denomVal={userMids[2].d} showInt={problem.config.mixed} activeField={activeField} inputType="mid" index={2} onFocus={(part) => setActiveField({ type: 'mid', index: 2, part })} />
                                                </>
                                            )}
                                            <span className="text-3xl font-black text-black">=</span>
                                    </div>
                                )}

                                <div>
                                    <FractionInput intVal={userInt} numVal={userNum} denomVal={userDenom} 
                                        showInt={problem.config.mixed} 
                                        activeField={activeField} inputType="final" index={null} onFocus={(part) => setActiveField({ type: 'final', index: null, part })} 
                                    />
                                </div>

                                {showImproperSimplify && (
                                    <div className="flex items-center animate-pop-in">
                                        <span className="text-3xl font-black text-black mx-0.5">=</span>
                                        <div className="flex items-center">
                                            <FractionInput 
                                                intVal={userSimpImproperInt} 
                                                numVal={userSimpImproperNum} 
                                                denomVal={userSimpImproperDenom} 
                                                showInt={problem.config.mixed} // å¸¯åˆ†æ•°ãƒ¢ãƒ¼ãƒ‰ãªã‚‰æ•´æ•°æ ã‚’è¡¨ç¤º
                                                activeField={activeField} 
                                                inputType="simpImproper" 
                                                index={null} 
                                                onFocus={(part) => setActiveField({ type: 'simpImproper', index: null, part })} 
                                            />
                                        </div>
                                    </div>
                                )}

                                {showMixedConvert && (
                                    <div className="flex items-center animate-pop-in">
                                        <span className="text-3xl font-black text-black mx-0.5">=</span>
                                        <div className="flex items-center">
                                            <FractionInput intVal={userMixedInt} numVal={userMixedNum} denomVal={userMixedDenom} showInt={true} activeField={activeField} inputType="mixed" index={null} onFocus={(part) => setActiveField({ type: 'mixed', index: null, part })} />
                                        </div>
                                    </div>
                                )}

                                {showSimplify && (
                                    <div className="flex items-center animate-pop-in">
                                        <span className="text-3xl font-black text-black mx-0.5">=</span>
                                        <div className="flex items-center">
                                            <FractionInput intVal={userSimpInt} numVal={userSimpNum} denomVal={userSimpDenom} showInt={problem.finalMixed.i > 0} activeField={activeField} inputType="simp" index={null} onFocus={(part) => setActiveField({ type: 'simp', index: null, part })} />
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="mt-2 flex flex-col items-center w-full">
                                <div className="min-h-[60px] flex flex-col items-center justify-center w-full mb-2 gap-2">
                                    {feedback && (
                                        <div className="flex flex-col items-center justify-center gap-2 animate-pop-in w-full">
                                            <p className={`text-center text-lg md:text-xl font-black ${isCorrect ? 'text-orange-500' : 'text-blue-500'}`}>
                                                {feedback}
                                            </p>
                                        </div>
                                    )}
                                    {isCorrect ? (
                                        <button onClick={() => newProblem()} className="px-6 py-2 bg-orange-500 text-white rounded-full font-bold text-lg hover:bg-orange-600 shadow-md transition-transform active:scale-95">
                                            æ¬¡ã¸ â¡
                                        </button>
                                    ) : (
                                        <button onClick={checkAnswer} className={`px-10 py-2 text-lg font-bold rounded-full shadow-md transform transition-all active:scale-95 bg-green-500 hover:bg-green-600 text-white`}>
                                            {buttonText}
                                        </button>
                                    )}
                                </div>
                                <div className="w-full max-w-lg mt-2">
                                    <NumberKeypad onInput={handlePadInput} />
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto bg-white p-2 border-t-2 border-dashed border-gray-200">
                             {showVisualizer && showHint ? (
                                <>
                                    <div className="flex flex-col gap-4 w-full max-w-2xl mx-auto mb-4">
                                        <div className="bg-blue-50 p-2 rounded-lg text-center">
                                            <p className="text-sm font-bold text-blue-800">
                                                {!problem.config.diffDenom 
                                                    ? (problem.config.type === 'sub' ? 'ãƒ’ãƒ³ãƒˆï¼šè‰²ãŒã¤ã„ã¦ã„ã‚‹éƒ¨åˆ†ã‚’ã²ã„ãŸæ•°ãŒåˆ†å­ã«ãªã‚Šã¾ã™' : 'ãƒ’ãƒ³ãƒˆï¼šè‰²ãŒã¤ã„ã¦ã„ã‚‹éƒ¨åˆ†ã‚’åˆã‚ã›ãŸæ•°ãŒåˆ†å­ã«ãªã‚Šã¾ã™')
                                                    : 'ãƒ’ãƒ³ãƒˆï¼šåˆ†æ¯ã‚’ãã‚ãˆã¾ã—ã‚‡ã†'
                                                }
                                            </p>
                                        </div>
                                        <div>
                                            <FractionBar f={problem.f1} splitFactor={commonSplit % problem.f1.d === 0 ? commonSplit / problem.f1.d : 1} color="bg-cyan-400" label="ã²ã¨ã¤ã‚" />
                                            <FractionBar f={problem.f2} splitFactor={commonSplit % problem.f2.d === 0 ? commonSplit / problem.f2.d : 1} color="bg-pink-400" label="ãµãŸã¤ã‚" />
                                        </div>
                                    </div>
                                    {problem.config.diffDenom && (
                                        <div className="bg-white p-3 rounded-xl border-2 border-blue-200 max-w-lg mx-auto mb-10 shadow-sm">
                                            <div className="text-center mb-1">
                                                <p className="text-sm font-bold text-blue-900">â— ã‚’å‹•ã‹ã—ã¦ <span className="text-orange-600">ã‚ã‚‚ã‚Šã®æ•°</span> ã‚’ãã‚ãˆã‚ˆã†</p>
                                            </div>
                                            <input type="range" min="2" max={maxSlider} value={commonSplit} onChange={(e) => setCommonSplit(parseInt(e.target.value))} className="w-full" />
                                            <div className="flex justify-between items-center mt-1 px-1">
                                                <span className="text-[10px] font-bold text-blue-400">ç´°ã‹ãã™ã‚‹ â–¶</span>
                                                <span className="text-sm font-black text-blue-600 bg-white px-2 rounded">{commonSplit}</span>
                                            </div>
                                        </div>
                                    )}
                                </>
                            ) : (
                                !showVisualizer ? (
                                    showHint ? (
                                        <div className="flex flex-col gap-2">
                                            {/* Canvasãƒ™ãƒ¼ã‚¹ã®ãƒ¡ãƒ¢ãƒ‘ãƒƒãƒ‰ */}
                                            <MemoPad />
                                        </div>
                                    ) : (
                                        <div className="h-full flex items-center justify-center text-gray-400 font-bold text-center p-4">
                                            ãƒ’ãƒ³ãƒˆã¯éè¡¨ç¤ºã§ã™
                                        </div>
                                    )
                                ) : (
                                    <div className="h-full flex items-center justify-center text-gray-400 font-bold text-center p-4">
                                        ãƒ’ãƒ³ãƒˆã¯éè¡¨ç¤ºã§ã™
                                    </div>
                                )
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isPlaying, setIsPlaying] = useState(false);
            const [level, setLevel] = useState(1);
            
            const [levelScores, setLevelScores] = useState(() => {
                const saved = localStorage.getItem('fractionMasterScores');
                return saved ? JSON.parse(saved) : {};
            });

            useEffect(() => {
                localStorage.setItem('fractionMasterScores', JSON.stringify(levelScores));
            }, [levelScores]);

            const handleCorrectAnswer = (lvl, points) => {
                setLevelScores(prev => ({
                    ...prev,
                    [lvl]: (prev[lvl] || 0) + points
                }));
            };

            return (
                <div className="h-full w-full">
                    {isPlaying ? (
                        <GameScreen 
                            initialLevel={level} 
                            onBack={() => setIsPlaying(false)}
                            onCorrectAnswer={handleCorrectAnswer}
                            levelScores={levelScores}
                        />
                    ) : (
                        <StartScreen 
                            onStart={(id) => {
                                setLevel(id);
                                setIsPlaying(true);
                            }} 
                            levelScores={levelScores}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>